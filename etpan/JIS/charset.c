#include "charset.h"static const char b64_table[65] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";void charset_encode_header(CJISString& chars,/* jis */													 const char *encoding,													 const char *header_name,													 CUTF16String& src,													 CUTF8String& address,													 CUTF8String& result){		CUTF8String name = (const uint8_t *)(header_name ? header_name : "");	CUTF8String encoding_name = (const uint8_t *)(encoding ? encoding : "shift_jis");	CUTF8String STRING_BEFORE = (const uint8_t *)"=?";	STRING_BEFORE += encoding_name;	STRING_BEFORE += (const uint8_t *)"?B?";	size_t STRING_BEFORE_LENGTH = STRING_BEFORE.length();	CUTF8String STRING_AFTER = (const uint8_t *)"?=";	size_t STRING_AFTER_LENGTH = STRING_AFTER.length();	CUTF8String STRING_FLOW = (const uint8_t *)"\r\n ";	size_t STRING_FLOW_LENGTH = 1;		int len = chars.size();	int before_last = len > 0 ? len-1 : 0;		int pos = name.length() + 2;// ": "	int max_line_length = MAX_LINE_LENGTH_FOR_HEADER - 5 - encoding_name.length() - pos;// =??B?, ?=		int bits_collected = 0;	unsigned int accumulator = 0;		CUTF8String dst;		CUTF8String buffer;		for(int i = 0; i < len; ++i)	{		if((i % HEADER_ENCODING_YIELD_SIZE)==0)		{			PA_YieldAbsolute();		}				unsigned short code = chars.at(i);				switch(code)		{			case 0x0000:				break;			default:				if((code >  0x0000) && (code <  0x0080))				{					buffer += code;				}else				{					buffer += ((code & 0xFF00) >> 8);					buffer +=  (code & 0x00FF);				}				break;		}		if(((buffer.length() / 3) * 4) >= max_line_length)		{			int buf_len = 0;			dst += STRING_BEFORE;			pos += STRING_BEFORE_LENGTH;			bits_collected = 0;			accumulator = 0;						for(int j = 0; j < buffer.length();++j)			{				accumulator = (accumulator << 8) | (buffer.at(j) & 0xffu);				bits_collected += 8;				while (bits_collected >= 6)				{					bits_collected -= 6;					dst += b64_table[(accumulator >> bits_collected) & 0x3fu];					buf_len++;					pos++;				}			}						if (bits_collected > 0)			{				accumulator <<= 6 - bits_collected;				dst += b64_table[accumulator & 0x3fu];				buf_len++;				pos++;			}						switch(buf_len % 4)			{				case 1:					dst += CUTF8String((const uint8_t *)"===");// 3					pos += 3;					break;				case 2:					dst += CUTF8String((const uint8_t *)"==");// 2					pos += 2;					break;				case 3:					dst += CUTF8String((const uint8_t *)"=");// 1					pos += 1;					break;			}						dst += STRING_AFTER;			pos += STRING_AFTER_LENGTH;						if(i != before_last)			{				dst += STRING_FLOW;// (2) 1				pos = STRING_FLOW_LENGTH;				max_line_length = MAX_LINE_LENGTH_FOR_HEADER - 5 - encoding_name.length();// =??B?, ?=			}						buffer = CUTF8String((const uint8_t *)"");		}	}//for		if(buffer.length())	{		int buf_len = 0;		dst += STRING_BEFORE;		pos += STRING_BEFORE_LENGTH;		bits_collected = 0;		accumulator = 0;				for(int j = 0; j < buffer.length();++j)		{			accumulator = (accumulator << 8) | (buffer.at(j) & 0xffu);			bits_collected += 8;			while (bits_collected >= 6)			{				bits_collected -= 6;				dst += b64_table[(accumulator >> bits_collected) & 0x3fu];				buf_len++;				pos++;			}		}				if (bits_collected > 0)		{			accumulator <<= 6 - bits_collected;			dst += b64_table[accumulator & 0x3fu];			buf_len++;			pos++;		}				switch(buf_len % 4)		{			case 1:				dst += CUTF8String((const uint8_t *)"===");				pos += 3;				break;			case 2:				dst += CUTF8String((const uint8_t *)"==");				pos += 2;				break;			case 3:				dst += CUTF8String((const uint8_t *)"=");				pos ++;				break;		}				dst += STRING_AFTER;		pos += STRING_AFTER_LENGTH;	}		CUTF8String a;	if(address.length())	{		if(len)		{			a += ' ';			a += '<';			a += address;			a += '>';			pos = 3 + address.length();		}else		{			a = address;			pos = 0;		}				for(int j = 0; j < a.length(); ++j)		{			pos += 1;			if(pos >= max_line_length)			{				dst += STRING_FLOW;// (2) 1				pos = STRING_FLOW_LENGTH;			}			dst += a.at(j);		}	}		result = dst;}